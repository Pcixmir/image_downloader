# Photo Downloader Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ S3 —á–µ—Ä–µ–∑ NATS.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Photo Downloader Service - —ç—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π:
- –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ NATS –ø–æ —Ç–µ–º–µ `photo_upload`
- –°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º file_id
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ S3 —Å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø–∞–ø–æ–∫
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ NATS

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
HTTP Client ‚Üí NATS Gateway ‚Üí NATS ‚Üí Photo Downloader ‚Üí S3
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ S3

```
uploads/
‚îú‚îÄ‚îÄ inf/                    # Inference –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ {bot_id}/
‚îÇ       ‚îî‚îÄ‚îÄ {chat_id}/
‚îÇ           ‚îî‚îÄ‚îÄ {job_id}/
‚îÇ               ‚îú‚îÄ‚îÄ photo1.jpg
‚îÇ               ‚îî‚îÄ‚îÄ photo2.jpg
‚îî‚îÄ‚îÄ train/                  # Training –æ–ø–µ—Ä–∞—Ü–∏–∏
    ‚îî‚îÄ‚îÄ {bot_id}/
        ‚îî‚îÄ‚îÄ {chat_id}/
            ‚îî‚îÄ‚îÄ {job_id}/
                ‚îú‚îÄ‚îÄ photo1.jpg
                ‚îî‚îÄ‚îÄ photo2.jpg
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- Poetry
- Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- NATS Server
- S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è**
```bash
git clone <repository-url>
cd photo-downloader-service
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```bash
make setup
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

3. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
```bash
make install
```

4. **–ó–∞–ø—É—Å–∫**
```bash
make run
```

### Docker

1. **–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞**
```bash
make build
```

2. **–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**
```bash
make docker-run
```

3. **–ó–∞–ø—É—Å–∫ —Å docker-compose (–≤–∫–ª—é—á–∞–µ—Ç NATS –∏ MinIO)**
```bash
make compose-up
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `NATS_URL` | URL NATS —Å–µ—Ä–≤–µ—Ä–∞ | `nats://localhost:4222` |
| `S3_ENDPOINT_URL` | URL S3 endpoint | - |
| `S3_ACCESS_KEY_ID` | S3 Access Key | - |
| `S3_SECRET_ACCESS_KEY` | S3 Secret Key | - |
| `S3_BUCKET_NAME` | –ò–º—è S3 bucket | - |
| `S3_REGION` | S3 —Ä–µ–≥–∏–æ–Ω | `us-east-1` |
| `MAX_FILE_SIZE_MB` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (MB) | `10` |
| `DOWNLOAD_TIMEOUT_SECONDS` | –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–µ–∫) | `30` |
| `LOG_LEVEL` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | `INFO` |

## üì° API

### NATS Topics

#### –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**Topic:** `photo_upload`

**–°—Ö–µ–º–∞:** `PhotoUploadRequest`
```json
{
  "header": "inf",                    // "inf" | "train"
  "file_id": ["photo1", "photo2"],    // –°–ø–∏—Å–æ–∫ ID —Ñ–∞–π–ª–æ–≤
  "s3_key": ["path1.jpg", "path2.jpg"], // –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π S3
  "bot_id": 12345,                    // ID –±–æ—Ç–∞
  "chat_id": 67890,                   // ID —á–∞—Ç–∞
  "job_id": 123                       // ID –∑–∞–¥–∞—á–∏
}
```

#### –ò—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**Topic:** `photo_upload_result` (—É—Å–ø–µ—Ö)

**–°—Ö–µ–º–∞:** `PhotoUploadResult`
```json
{
  "header": "inf",
  "file_id": ["photo1", "photo2"],
  "s3_key": ["uploads/inf/12345/67890/123/path1.jpg"],
  "s3_url": ["https://bucket.s3.amazonaws.com/uploads/inf/12345/67890/123/path1.jpg"],
  "bot_id": 12345,
  "chat_id": 67890,
  "job_id": 123,
  "message": "Successfully uploaded 2 photos"
}
```

**Topic:** `photo_upload_error` (–æ—à–∏–±–∫–∞)

**–°—Ö–µ–º–∞:** `PhotoUploadError`
```json
{
  "header": "inf",
  "file_id": ["photo1"],
  "bot_id": 12345,
  "chat_id": 67890,
  "job_id": 123,
  "error": "File size exceeds maximum",
  "error_code": "VALIDATION_ERROR"
}
```

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ö–æ–º–∞–Ω–¥—ã Make

```bash
make help           # –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
make install        # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
make dev            # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
make run            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
make test           # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
make lint           # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–∞–º–∏
make format         # –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
make clean          # –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
make check          # –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (lint + test)
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
photo-downloader-service/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastStream
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.py          # Pydantic —Å—Ö–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ s3_service.py       # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ photo_downloader.py # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py         # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ logger.py           # –£—Ç–∏–ª–∏—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ pyproject.toml              # Poetry –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile                  # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml          # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
‚îú‚îÄ‚îÄ Makefile                    # –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îú‚îÄ‚îÄ env.example                 # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
make test

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
poetry run pytest --cov=app

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
poetry run pytest tests/test_photo_downloader.py
```

### –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
make lint

# –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
make format

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
make check
```

## üê≥ Docker

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å docker-compose

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (NATS, MinIO, Photo Downloader)
make compose-up

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
make compose-logs

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
make compose-down
```

### –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º

- **NATS**: `localhost:4222`
- **NATS Monitoring**: `http://localhost:8222`
- **MinIO Console**: `http://localhost:9001` (admin/admin123)
- **MinIO API**: `http://localhost:9000`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `personix-logger` –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
from app.utils.logger import logger

logger.info("Processing photo upload", extra={
    "job_id": request.job_id,
    "file_count": len(request.file_id)
})
```

### –ú–µ—Ç—Ä–∏–∫–∏

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
- –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
- –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ NATS**
   ```
   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ NATS_URL –≤ .env —Ñ–∞–π–ª–µ
   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ NATS —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
   ```

2. **–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ S3**
   ```
   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ S3 credentials –≤ .env
   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ bucket —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
   ```

3. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞**
   ```
   –£–≤–µ–ª–∏—á—å—Ç–µ MAX_FILE_SIZE_MB –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
   ```

### –õ–æ–≥–∏

```bash
# Docker –ª–æ–≥–∏
make docker-logs

# docker-compose –ª–æ–≥–∏
make compose-logs

# –õ–æ–∫–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
tail -f logs/photo-downloader.log
```

## ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç

1. –§–æ—Ä–∫–Ω–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –°–æ–∑–¥–∞–π—Ç–µ feature –≤–µ—Ç–∫—É (`git checkout -b feature/amazing-feature`)
3. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (`git commit -m 'Add amazing feature'`)
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ –≤–µ—Ç–∫—É (`git push origin feature/amazing-feature`)
5. –û—Ç–∫—Ä–æ–π—Ç–µ Pull Request

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ MIT License - —Å–º. —Ñ–∞–π–ª [LICENSE](LICENSE) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [Issues](../../issues)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Issue —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ 